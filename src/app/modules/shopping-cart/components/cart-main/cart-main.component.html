<form [formGroup]="form">
  <main class="px-4 pb-6"> <!-- üëà extra Bottom-Padding -->

    <ng-container *ngIf="form.getRawValue().items.length > 0; else noProduct">

      <!-- Produkte (dezent, keine Card) -->
      <section class="mt-2 divide-y divide-gray-200">
        <oxp-cart-product
          *ngFor="let ctrl of itemsArray.controls; let index = index"
          class="block py-3 first:pt-0 last:pb-0 hover:bg-gray-50/60 transition"
          [productCart]="ctrl.value"
          (removeProduct)="removeProduct.emit(index)">
        </oxp-cart-product>
      </section>

      <!-- Age-Hinweis -->
      <div *ngIf="ageRestricted"
           class="mt-3 rounded-lg border border-amber-200 bg-amber-50/70 px-3 py-2 text-sm text-amber-800">
        {{ 'AGE_RESTRICTION_HINT' | translate }}
      </div>

      <!-- Zahlarten -->
      <ng-container *ngIf="!onlyPhisicalPayment">
        <h2 class="mt-5 text-xl font-semibold tracking-wide text-gray-800">
          {{ 'BEZAHLOPTIONEN' | translate | uppercase }}
        </h2>

        <mat-radio-group class="oxp-custom-group mt-2 flex flex-col gap-1" color="primary" formControlName="paymentType">
          <mat-radio-button
            *ngFor="let paymentMethod of restaurantInfo?.acceptedPaymentChannels"
            [value]="paymentMethod"
            (click)="paymentTypeChange(paymentMethod)"
            class="group rounded-lg px-2 py-2 transition hover:bg-gray-50 focus:bg-gray-50 [&.mat-radio-checked]:bg-gray-100">
            <span class="py-1 text-gray-800 group-[.mat-radio-checked]:font-semibold">
              {{ paymentMethod | translate | uppercase }}
            </span>
          </mat-radio-button>
        </mat-radio-group>
      </ng-container>

      <!-- Kommentar -->
      <!-- Kommentar: clean, ohne Mat-Wrapper -->
      <section class="mt-5">
        <label for="notes" class="mb-1 block text-sm font-medium text-gray-800">
          {{ 'SHOPPINGCART_COMMENT' | translate }}
        </label>

        <div
          class="rounded-2xl border border-gray-300 bg-white shadow-sm transition
           focus-within:border-black focus-within:ring-1 focus-within:ring-black/30">
    <textarea
      id="notes"
      formControlName="notes"
      placeholder="{{ 'OPTIONAL' | translate }}"
      cdkTextareaAutosize
      [cdkAutosizeMinRows]="3"
      [cdkAutosizeMaxRows]="8"
      maxlength="300"
      class="w-full resize-none rounded-2xl border-0 bg-transparent px-4 py-3
             text-base text-gray-900 placeholder:text-gray-400
             focus:outline-none focus:ring-0"
    ></textarea>
        </div>

        <div class="mt-1 flex items-center justify-between text-xs text-gray-500">
          <span>{{ 'Du kannst Hinweise f√ºr die K√ºche hinzuf√ºgen.' | translate }}</span>
          <span>{{ ($any(form.get('notes')?.value)?.length || 0) }} / 300</span>
        </div>
      </section>


      <!-- TRINKGELD -->
      <ng-container *ngIf="!onlyPhisicalPayment && form.get('paymentType')?.value !== 'PHYSICAL'">
        <h4 class="pt-6 text-xl font-semibold tracking-wide text-gray-800">
          {{ 'TRINKGELD' | translate | uppercase }}
        </h4>

        <div class="mt-3 flex flex-col gap-4">

          <!-- Segmented Control: gleich breite Segmente -->
          <div role="tablist" aria-label="Tip mode"
               class="grid grid-cols-3 overflow-hidden rounded-full border border-gray-200 bg-white">

            <button type="button" role="tab"
                    [attr.aria-selected]="tipType.value==='none' ? 'true' : 'false'"
                    class="w-full whitespace-nowrap px-4 py-2 text-base sm:text-base font-medium text-center transition"
                    [class.bg-black]="tipType.value==='none'"
                    [class.text-white]="tipType.value==='none'"
                    [class.text-gray-700]="tipType.value!=='none'"
                    (click)="tipType.setValue('none')">
              {{ 'KEINTRINKGELD' | translate }}
            </button>

            <button type="button" role="tab"
                    [attr.aria-selected]="tipType.value==='%' ? 'true' : 'false'"
                    class="w-full whitespace-nowrap px-4 py-2 text-base sm:text-base font-medium text-center transition"
                    [class.bg-black]="tipType.value==='%'"
                    [class.text-white]="tipType.value==='%'"
                    [class.text-gray-700]="tipType.value!=='%'"
                    (click)="tipType.setValue('%')">%</button>

            <button type="button" role="tab"
                    [attr.aria-selected]="tipType.value==='custom' ? 'true' : 'false'"
                    class="w-full whitespace-nowrap px-4 py-2 text-base sm:text-base font-medium text-center transition"
                    [class.bg-black]="tipType.value==='custom'"
                    [class.text-white]="tipType.value==='custom'"
                    [class.text-gray-700]="tipType.value!=='custom'"
                    (click)="tipType.setValue('custom')">Custom</button>
          </div>

          <!-- Prozent + Shortcuts (fingerfreundlich) -->
          <div *ngIf="tipType.value === '%'" class="flex flex-col gap-3">
            <div class="flex flex-wrap items-center gap-3">
              <!-- Dein Counter (etwas gr√∂√üer) -->
              <oxp-counter-button
                [formCtrl]="tipValuePercent"
                class="h-10 rounded-xl border border-gray-300">
              </oxp-counter-button>

              <!-- Chips: gr√∂√üere Hit-Area -->
              <button type="button"
                      class="min-h-10 rounded-full border border-gray-200 px-4 py-2 text-base sm:text-lg font-medium text-gray-700 transition
         hover:border-black hover:bg-black/5 hover:text-black"
                      (click)="tipValuePercent.setValue(5)">5%</button>

              <button type="button"
                      class="min-h-10 rounded-full border border-gray-200 px-4 py-2 text-base sm:text-lg font-medium text-gray-700 transition
         hover:border-black hover:bg-black/5 hover:text-black"
                      (click)="tipValuePercent.setValue(10)">10%</button>

              <button type="button"
                      class="min-h-10 rounded-full border border-gray-200 px-4 py-2 text-base sm:text-lg font-medium text-gray-700 transition
         hover:border-black hover:bg-black/5 hover:text-black"
                      (click)="tipValuePercent.setValue(12)">12%</button>
            </div>

            <div class="text-base text-gray-600">
              {{ 'DEINTRINKGELD' | translate }}
              <span class="font-semibold text-gray-900">
                {{
                (this.currentPriceWithoutTip * (tipValuePercent.value! / 100)) / 100
                  | currency : 'EUR' : undefined : undefined : translateService.getBrowserLang()
                }}
              </span>
            </div>
          </div>

          <!-- Custom Betrag (Tailwind-Input) -->
          <div *ngIf="tipType.value === 'custom'" class="flex flex-wrap items-center gap-3">
            <label class="w-full text-xs font-medium text-gray-600">{{ 'TRINKGELD' | translate }}</label>
            <div class="flex items-center overflow-hidden rounded-xl border border-gray-300 bg-white">
              <span class="px-3 text-gray-500 select-none">‚Ç¨</span>
              <input
                type="number" inputmode="decimal"
                [formControl]="tipValueCustom"
                min="0.01" max="100000000" step="0.01"
                class="w-28 border-0 px-3 py-2 text-right outline-none focus:ring-0" />
            </div>

            <div class="text-base text-gray-600">
              {{ 'DEINTRINKGELD' | translate }}
              <span class="font-semibold text-gray-900">
                {{
                (tipValueCustom.value || 0)
                  | currency : 'EUR' : undefined : undefined : translateService.getBrowserLang()
                }}
              </span>
            </div>
          </div>

        </div>
      </ng-container>

    </ng-container>

    <ng-template #noProduct>
      <div class="py-10 text-center text-gray-600">
        {{ 'WARENKORB_IST_LEER' | translate }}
      </div>
    </ng-template>
  </main>
</form>
