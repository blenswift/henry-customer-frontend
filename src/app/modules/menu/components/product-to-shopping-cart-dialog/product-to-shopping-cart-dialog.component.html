<!-- Produkt-BottomSheet – Tailwind-Version (Angular + Angular Material) -->
<div class="flex h-full flex-col overflow-hidden bg-neutral-50">
  <!-- Header mit Bild + Glas-Overlay -->
  <header class="relative w-full">
    <img
      *ngIf="data.product.imageUrl"
      class="h-56 w-full object-cover object-center"
      [src]="data.product.imageUrl"
      alt="{{ data.product.name }}"
    />

    <!-- Gradient Overlay -->
    <div class="pointer-events-none absolute inset-0 bg-gradient-to-b from-black/10 to-black/50"></div>

    <!-- Close-Button (X) – polished -->
    <button
      type="button"
      (click)="bottomSheetRef.dismiss()"
      aria-label="Schließen"
      class="absolute right-3 top-3 z-20 grid h-10 w-10 place-items-center rounded-full
             bg-white/90 backdrop-blur ring-1 ring-black/10 shadow-sm
             hover:bg-white hover:shadow-md active:scale-95
             focus:outline-none focus-visible:ring-2 focus-visible:ring-black/30">
      <mat-icon class="text-slate-700">close</mat-icon>
    </button>

    <!-- Titel + Badges auf dem Bildfuß -->
    <div class="absolute bottom-2 left-0 right-0 z-10 flex items-center gap-2 px-4">
      <h1 class="truncate text-balance text-2xl font-semibold tracking-tight text-white drop-shadow">
        {{ data.product.name }}
      </h1>
      <div class="ml-auto flex items-center gap-2">
        <mat-chip *ngIf="data.product.legalAge > 0" selected color="warn" class="!text-white">
          {{ 'AGE_RESTRICTED' | translate }} ({{ data.product.legalAge }})
        </mat-chip>
        <button
          mat-stroked-button
          color="primary"
          class="backdrop-blur-sm !text-white/95 !border-white/60 bg-white/10 hover:bg-white/20"
          (click)="openInfo()"
          aria-label="Allergene & Zusatzstoffe">
          <mat-icon class="!text-white">info</mat-icon>
          <span class="ml-2 hidden sm:inline">{{ 'Allergene & Zusatzstoffe' }}</span>
        </button>
      </div>
    </div>
  </header>

  <main class="flex-1 overflow-y-auto pb-28">
    <section class="px-4 pt-3">
      <!-- Beschreibung -->
      <div *ngIf="data.product.description" class="rounded-2xl bg-white p-4 shadow-sm ring-1 ring-black/5">
        <h2 class="mb-1 text-sm font-semibold tracking-wide text-neutral-600">{{ 'BESCHREIBUNG' | translate }}</h2>
        <p class="leading-relaxed text-neutral-700">{{ data.product.description }}</p>
      </div>

      <!-- Zutaten -->
      <div *ngIf="data.product.ingredients?.length" class="mt-3 rounded-2xl bg-white p-4 shadow-sm ring-1 ring-black/5">
        <div class="mb-2 flex items-center gap-2">
          <mat-icon class="text-neutral-500">spa</mat-icon>
          <h2 class="text-base font-semibold text-neutral-800">{{ 'ZUTATEN' | translate }}</h2>
        </div>
        <mat-divider class="my-2"></mat-divider>
        <mat-chip-set class="flex flex-wrap gap-2" aria-label="Zutatenliste">
          <mat-chip *ngFor="let ingredient of data.product.ingredients" class="rounded-full bg-neutral-100 text-neutral-800">
            {{ ingredient }}
          </mat-chip>
        </mat-chip-set>
      </div>

      <!-- Extra-Gruppen (Auswahl) -->
      <ng-container *ngIf="data.qrCodeType !== 'MENU'">
        <div
          *ngFor="let extraGroup of data.product.extraGroups"
          class="mt-3 overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-black/5">

          <div class="px-4 pt-4">
            <div class="flex items-end gap-2">
              <h3 class="text-base font-semibold text-neutral-900">
                {{ extraGroup.name }}
                <span *ngIf="extraGroup.maxSelections > 1" class="text-sm font-normal text-neutral-500">
                  — max. {{ extraGroup.maxSelections }}
                </span>
              </h3>
              <!-- Auswahl-Status nur für Checkbox/Multi -->
              <span *ngIf="extraGroup.selectionType !== 'RADIO_GROUP'"
                    class="ml-auto text-sm text-neutral-500">
                {{ selectedCount(extraGroup) }} / {{ extraGroup.maxSelections || '∞' }} {{ 'ausgewählt' }}
              </span>
            </div>
          </div>

          <!-- RADIO GROUP -->
          <mat-radio-group
            *ngIf="extraGroup.selectionType === 'RADIO_GROUP'"
            color="primary"
            [(ngModel)]="extraGroup.selected"
            class="divide-y divide-neutral-100 px-4">
            <mat-radio-button
              *ngFor="let extra of extraGroup.extras"
              [value]="extra.id"
              [disabled]="!extra.available"
              class="block py-3">
              <div class="w-full flex items-center gap-2">
                <!-- links: Name + Badge -->
                <div class="min-w-0 flex-1 flex items-center gap-2">
                  <span class="font-medium text-neutral-900" [ngClass]="{ 'opacity-50': !extra.available }">
                    {{ extra.name }}
                  </span>
                  <span class="rounded-full border border-rose-300/60 bg-rose-50 px-2 py-0.5 text-xs font-medium text-rose-500" *ngIf="!extra.available">
                    {{ 'AUSVERKAUFT' | translate }}
                  </span>
                </div>

                <!-- rechts: Preis (fixe Spalte, rechtsbündig) -->
                <span
                  *ngIf="((extra?.price ?? 0) > 0)"
                  class="w-[7rem] tabular-nums text-right"
                  [ngClass]="{ 'text-neutral-400': !extra.available, 'text-neutral-700': extra.available }">
                  + {{ ((extra?.price ?? 0) / 100) | currency:'EUR':undefined:undefined:translateService.getBrowserLang() }}
                </span>
              </div>
            </mat-radio-button>
          </mat-radio-group>

          <!-- CHECKBOX GROUP -->
          <div *ngIf="extraGroup.selectionType === 'CHECKBOX'" class="divide-y divide-neutral-100 px-4">
            <mat-checkbox
              *ngFor="let extra of extraGroup.extras"
              color="primary"
              [disabled]="!(extraGroup | checkable : extra) || !extra.available"
              [(ngModel)]="extra.selected"
              class="block py-3">
              <div class="w-full flex items-center gap-2">
                <!-- links -->
                <div class="min-w-0 flex-1 flex items-center gap-2">
                  <span class="font-medium text-neutral-900"
                        [ngClass]="{
                          'line-through opacity-50': !extra.available,
                          'opacity-50': !(extraGroup | checkable : extra) && extra.available
                        }">
                    {{ extra.name }}
                  </span>
                  <span class="rounded-full border border-rose-300/60 bg-rose-50 px-2 py-0.5 text-xs font-medium text-rose-500" *ngIf="!extra.available">
                    {{ 'AUSVERKAUFT' | translate }}
                  </span>
                </div>

                <!-- rechts -->
                <span
                  *ngIf="((extra?.price ?? 0) > 0)"
                  class="w-[7rem] tabular-nums text-right"
                  [ngClass]="{ 'text-neutral-400': !extra.available, 'text-neutral-700': extra.available }">
                  + {{ ((extra?.price ?? 0) / 100) | currency:'EUR':undefined:undefined:translateService.getBrowserLang() }}
                </span>

                <!-- Limit-Hinweis -->
                <span class="ml-2 text-xs text-neutral-400" *ngIf="!(extraGroup | checkable : extra) && extra.available">
                  {{ 'Limit erreicht' }}
                </span>
              </div>
            </mat-checkbox>
          </div>

          <!-- MULTI SELECT (eigene Komponente rendert Inhalte) -->
          <div *ngIf="extraGroup.selectionType === 'MULTI_SELECT'" class="px-4 pb-3">
            <div class="mb-2 text-right text-sm text-neutral-500">
              {{ selectedCount(extraGroup) }} / {{ extraGroup.maxSelections || '∞' }} {{ 'ausgewählt' }}
            </div>
            <oxp-multiselect-checkbox-group
              [extras]="extraGroup.extras"
              [maxValue]="extraGroup.maxSelections">
            </oxp-multiselect-checkbox-group>
          </div>
        </div>
      </ng-container>

      <!-- Menü-Ansicht (nur Anzeige) -->
      <ng-container *ngIf="data.qrCodeType === 'MENU'">
        <div
          *ngFor="let extraGroup of data.product.extraGroups"
          class="mt-3 overflow-hidden rounded-2xl bg-white shadow-sm ring-1 ring-black/5">
          <div class="px-4 pt-4">
            <h3 class="text-base font-semibold text-neutral-900">{{ extraGroup.name }}</h3>
          </div>
          <div class="divide-y divide-neutral-100 px-4">
            <div *ngFor="let extra of extraGroup.extras" class="flex items-center gap-2 py-3">
              <div class="min-w-0 flex-1">
                <span class="font-medium text-neutral-900" [ngClass]="{ 'opacity-50 line-through': !extra.available }">
                  {{ extra.name }}
                </span>
                <span class="ml-2 rounded-full border border-rose-300/60 bg-rose-50 px-2 py-0.5 text-xs font-medium text-rose-500" *ngIf="!extra.available">
                  {{ 'AUSVERKAUFT' | translate }}
                </span>
              </div>

              <!-- rechts: Preis -->
              <span
                *ngIf="((extra?.price ?? 0) > 0)"
                class="w-[7rem] tabular-nums text-right"
                [ngClass]="{ 'text-neutral-400': !extra.available, 'text-neutral-700': extra.available }">
                + {{ ((extra?.price ?? 0) / 100) | currency:'EUR':undefined:undefined:translateService.getBrowserLang() }}
              </span>
            </div>
          </div>
        </div>
      </ng-container>
    </section>
  </main>

  <!-- Sticky Footer (Glas) -->
  <footer *ngIf="data.qrCodeType !== 'MENU'" class="sticky bottom-0 left-0 right-0 border-t border-black/10 bg-white/80 backdrop-blur-md">
    <div class="mx-auto flex max-w-screen-sm items-center gap-3 px-4 py-3">
      <oxp-counter-button [(value)]="data.quantity"></oxp-counter-button>
      <button
        mat-flat-button
        color="primary"
        class="ml-auto inline-flex items-center gap-2 rounded-full px-5"
        (click)="bottomSheetRef.dismiss(data)">
        {{ 'HINZUFUEGEN' | translate }}
        <span class="font-bold">
          {{ ((data | sumOfProduct) * data.quantity) / 100 | currency:'EUR':undefined:undefined:translateService.getBrowserLang() }}
        </span>
      </button>
    </div>
  </footer>
</div>
